<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.my.team.TeamMapper">
	<!-- 서현 -->
	<select id="selectCount" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM TEAM
	</select>
	<!-- 확인 필요 -->
	<select id="selectByTeamNo" resultType="TeamDTO">
		SELECT team_name,
		study_type, onoffline, max_member,
		startdate, enddate,
		brief_info,
		team_info,
		(select LISTAGG(hashtag_name, ',') from TEAM_HASHTAG b
		where
		b.team_no =
		a.team_no)
		AS hashtags
		FROM TEAM a
		WHERE
		team_no = ${teamNo}
	</select>
	<select id="selectByTeamName" resultType="TeamDTO">
		SELECT team_name,
		brief_info, viewcnt
		FROM TEAM
		WHERE team_name = #{teamName}
	</select>
	<!-- 확인 필요 -->
	<select id="selectByHashtag" resultType="TeamDTO" parameterType="java.util.HashMap">
		SELECT * FROM (SELECT rownum rn, c.* FROM(SELECT team_name,
		study_type, onoffline, join_member, max_member,
		startdate, enddate,
		brief_info,
		(select LISTAGG(hashtag_name, ',') from TEAM_HASHTAG b
		where b.team_no =
		a.team_no)
		AS hashtags, viewcnt
		FROM TEAM a
		WHERE
		team_no IN
		(SELECT team_no FROM TEAM_HASHTAG
		WHERE hashtag_name LIKE
		'%${hashtag, jdbcType=VARCHAR}%')) c)
		WHERE rn BETWEEN #{start, jdbcType=INTEGER}AND #{end, jdbcType=INTEGER}
	</select>
	<select id="selectByCondition" resultType="TeamDTO" parameterType="java.util.HashMap">
		SELECT * FROM (SELECT rownum rn, c.* FROM(SELECT team_name,
		study_type, onoffline, join_member, max_member,
		startdate, enddate,
		brief_info,
		(select LISTAGG(hashtag_name, ',') from TEAM_HASHTAG b
		where b.team_no =
		a.team_no)
		AS hashtags, viewcnt
		FROM TEAM a
		WHERE
		TO_DATE(enddate, 'YYYY-MM-DD') > sysdate
		ORDER BY ${column} DESC) c)
		WHERE rn BETWEEN #{start}AND #{end}
	</select>
	<select id="createTeam" statementType="CALLABLE" parameterType="hashMap">
    {call CREATE_TEAM(
            #{I_TEAM_NAME, mode=IN, jdbcType=VARCHAR},
            #{I_LEADER_ID, mode=IN, jdbcType=VARCHAR},
            #{I_STUDY_TYPE, mode=IN, jdbcType=VARCHAR},
            #{I_ONOFFLINE, mode=IN, jdbcType=VARCHAR},
            #{I_MAX_MEMBER, mode=IN, jdbcType=INTEGER},
            #{I_STARTDATE, mode=IN, jdbcType=VARCHAR},
            #{I_ENDDATE, mode=IN, jdbcType=VARCHAR},
			#{I_BRIEF_INFO, mode=IN, jdbcType=VARCHAR},
			#{I_TEAM_INFO, mode=IN, jdbcType=VARCHAR},
			#{I_HASHTAG_NAME1, mode=IN, jdbcType=VARCHAR},
			#{I_HASHTAG_NAME2, mode=IN, jdbcType=VARCHAR},
			#{I_HASHTAG_NAME3, mode=IN, jdbcType=VARCHAR},
			#{I_HASHTAG_NAME4, mode=IN, jdbcType=VARCHAR},
			#{I_HASHTAG_NAME5, mode=IN, jdbcType=VARCHAR}
        )
    }
	</select>
	<update id="updateTeam" parameterType="TeamDTO">
		UPDATE TEAM
		SET team_name =
		#{teamName},
		study_type = #{studyType},
		onoffline = #{onOffLine},
		max_member = #{maxMember},
		startdate = #{startDate},
		enddate = #{endDate},
		brief_info = #{briefInfo},
		team_info = #{teamInfo}
		WHERE team_no = #{teamNo}
	</update>
	<delete id="deleteTeam" statementType="CALLABLE" parameterType="int">
	    {call DELETE_TEAM(
            #{I_TEAM_NO, mode=IN, jdbcType=INTEGER}
        )
    }
	</delete>
	<delete id="deleteHashtag" parameterType="int">
		DELETE FROM TEAM_HASHTAG
		WHERE team_no = ${teamNo}
	</delete>
	<update id="insertHashtag" parameterType="java.util.Map">
        <foreach collection="list" item="item" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL">
            INTO TEAM_HASHTAG(hashtag_name, team_no)
    		VALUES (#{item.hashtag}, ${item.teamNo})
        </foreach>
 	</update>
	<update id="updateViewCnt" parameterType="int">
		UPDATE TEAM
		SET viewcnt = viewcnt + 1
		WHERE team_no = ${teamNo}
	</update>	
	<!-- ###################################################################################################################### -->
	<!-- 셍나 -->
	
	<!-- 공지 게시판 글 가져오기 -->
	<select id="selectByNoticeNo" parameterType="NoticeDTO">
		SELECT notice_no, notice_title, notice_content, regdate
		FROM (
		    SELECT notice_no, notice_title, notice_content, regdate
		    FROM ${tableName}
		    ORDER BY main_status DESC, regdate DESC
		) WHERE ROWNUM <![CDATA[ <= ]]> 3;
	</select>
	
	<!-- 팀 소개글 가져오기 -->
	<select id="selectBy" parameterType="TeamDTO">
		SELECT team_info
		FROM TEAM
		WHERE team_no = ${teamNo};
	</select>
	
	<!--  -->
	
	
	<select id="selectLeaderId" resultType = "String" parameterType="Integer">
		SELECT leader_id
		FROM TEAM
		WHERE team_no = #{teamNo}
	</select>
	
</mapper>